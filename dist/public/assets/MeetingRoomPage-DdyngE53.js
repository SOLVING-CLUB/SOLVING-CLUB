var Te=Object.defineProperty;var Ue=(c,t,a)=>t in c?Te(c,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):c[t]=a;var p=(c,t,a)=>Ue(c,typeof t!="symbol"?t+"":t,a);import{c as z,g as ae,r as l,j as e,q as H,s as se,v as ne,w as re,x as ke,e as G,V as ie,B as R,U as Pe,M as Ae,y as Ie,I as Re,z as $e,i as qe,E as De,u as Ve,t as ve,X as ze,F as Le,G as Oe,H as He,J as Be,K as be,N as je}from"./index-BeoiXK9q.js";/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=[["path",{d:"M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z",key:"1vdc57"}],["path",{d:"M5 21h14",key:"11awu3"}]],Je=z("crown",Fe);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M16.95 16.95A7 7 0 0 1 5 12v-2",key:"cqa7eg"}],["path",{d:"M18.89 13.23A7 7 0 0 0 19 12v-2",key:"16hl24"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}]],oe=z("mic-off",Ye);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],le=z("mic",Ge);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=[["path",{d:"M17 17H4a2 2 0 0 1-2-2V5c0-1.5 1-2 1-2",key:"k0q8oc"}],["path",{d:"M22 15V5a2 2 0 0 0-2-2H9",key:"cp1ac0"}],["path",{d:"M8 21h8",key:"1ev6f3"}],["path",{d:"M12 17v4",key:"1riwvh"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],Ke=z("monitor-off",We);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=[["rect",{width:"20",height:"14",x:"2",y:"3",rx:"2",key:"48i651"}],["line",{x1:"8",x2:"16",y1:"21",y2:"21",key:"1svkeh"}],["line",{x1:"12",x2:"12",y1:"17",y2:"21",key:"vw1qmm"}]],Qe=z("monitor",Xe);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]],et=z("phone-off",Ze);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tt=[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.5l5.248-3.062A.5.5 0 0 1 22 7.87v8.196",key:"w8jjjt"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2",key:"1xawa7"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],ce=z("video-off",tt);class at{constructor(){p(this,"supabase",ae());p(this,"channel",null);p(this,"meetingId",null);p(this,"userId",null);p(this,"onSignalCallback",null);p(this,"onParticipantChangeCallback",null);p(this,"onMessageCallback",null)}async joinMeeting(t,a){return this.meetingId=t,this.userId=a,this.channel&&await this.leaveMeeting(),this.channel=this.supabase.channel(`meeting-${t}`,{config:{broadcast:{self:!1}}}).on("broadcast",{event:"webrtc-signal"},n=>{const i=n.payload;i.toUserId===a&&this.onSignalCallback&&this.onSignalCallback(i)}).on("postgres_changes",{event:"*",schema:"public",table:"meeting_participants",filter:`meeting_id=eq.${t}`},n=>{this.loadParticipants()}).on("postgres_changes",{event:"*",schema:"public",table:"meeting_messages",filter:`meeting_id=eq.${t}`},n=>{this.onMessageCallback&&this.onMessageCallback(n)}).subscribe(n=>{n==="SUBSCRIBED"&&(console.log("âœ… Connected to meeting signaling channel"),this.loadParticipants())}),this.channel}async loadParticipants(){if(!this.meetingId)return;const{data:t,error:a}=await this.supabase.from("meeting_participants").select("*").eq("meeting_id",this.meetingId).is("left_at",null).order("joined_at",{ascending:!0});if(a){console.error("Error loading participants:",a);return}if(t&&this.onParticipantChangeCallback){const n=t.map(i=>({userId:i.user_id,joinedAt:i.joined_at,role:i.role,audioEnabled:i.audio_enabled,videoEnabled:i.video_enabled,screenSharing:i.screen_sharing,handRaised:i.hand_raised,connectionStatus:i.connection_status}));this.onParticipantChangeCallback(n)}}sendSignal(t,a,n){if(!this.channel||!this.meetingId||!this.userId){console.error("Not connected to meeting");return}const i={meetingId:this.meetingId,fromUserId:this.userId,toUserId:t,signal:a,signalType:n};this.channel.send({type:"broadcast",event:"webrtc-signal",payload:i})}broadcastToAll(t,a){if(!this.channel||!this.meetingId||!this.userId){console.error("Not connected to meeting");return}const n={meetingId:this.meetingId,fromUserId:this.userId,toUserId:"all",signal:t,signalType:a};this.channel.send({type:"broadcast",event:"webrtc-signal",payload:n})}onSignal(t){this.onSignalCallback=t}onParticipantChange(t){this.onParticipantChangeCallback=t}onMessage(t){this.onMessageCallback=t}async leaveMeeting(){this.channel&&(await this.supabase.removeChannel(this.channel),this.channel=null),this.meetingId=null,this.userId=null,this.onSignalCallback=null,this.onParticipantChangeCallback=null,this.onMessageCallback=null}}class st{constructor(t){p(this,"peers",new Map);p(this,"localStream",null);p(this,"localScreenStream",null);p(this,"signaling");p(this,"onStreamCallback",null);p(this,"onStreamEndCallback",null);p(this,"onErrorCallback",null);p(this,"meetingId",null);p(this,"currentUserId",null);p(this,"iceServers",{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]});this.signaling=t,this.setupSignalingHandlers()}initialize(t,a){this.meetingId=t,this.currentUserId=a}setupSignalingHandlers(){this.signaling.onSignal(t=>{this.handleSignal(t)})}async initializeLocalStream(t=!0,a=!0){var n,i;try{if(typeof window>"u"||typeof navigator>"u")throw new Error("Not running in a browser environment");this.localStream&&this.localStream.getTracks().forEach(s=>s.stop());const r={audio:t?{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}:!1,video:a?{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}}:!1};try{if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)this.localStream=await navigator.mediaDevices.getUserMedia(r);else if(navigator.getUserMedia)this.localStream=await new Promise((s,f)=>{navigator.getUserMedia(r,s,f)});else{const s=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",f=window.location.protocol==="https:";throw!s&&!f?new Error(`getUserMedia requires HTTPS or localhost. You're accessing via ${window.location.protocol}//${window.location.hostname}. Please use https:// or http://localhost:5173`):new Error("getUserMedia is not available in this browser. Please check your browser permissions and ensure WebRTC is supported.")}}catch(s){throw s.name==="NotAllowedError"||s.name==="PermissionDeniedError"?new Error("Camera/microphone access denied. Please allow permissions in your browser settings."):s.name==="NotFoundError"||s.name==="DevicesNotFoundError"?new Error("No camera or microphone found. Please connect a device and try again."):s.name==="NotReadableError"||s.name==="TrackStartError"?new Error("Camera/microphone is already in use by another application."):(n=s.message)!=null&&n.includes("secure context")||(i=s.message)!=null&&i.includes("HTTPS")?new Error(`getUserMedia requires HTTPS or localhost. Current URL: ${window.location.href}. Please use https:// or http://localhost:5173`):s}return this.onStreamCallback&&this.currentUserId&&this.onStreamCallback(this.currentUserId,this.localStream,!0),this.peers.forEach(s=>{this.localStream&&this.localStream.getTracks().forEach(f=>{const w=s.pc.getSenders().find(b=>{var u;return((u=b.track)==null?void 0:u.kind)===f.kind});w?w.replaceTrack(f):s.pc.addTrack(f,this.localStream)})}),this.localStream}catch(r){throw console.error("Error getting user media:",r),r}}async startScreenShare(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)throw new Error("Screen sharing is not supported in this browser");return this.localScreenStream?this.localScreenStream:(this.localScreenStream=await navigator.mediaDevices.getDisplayMedia({video:{width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}},audio:!0}),this.localScreenStream.getVideoTracks()[0].addEventListener("ended",()=>{this.stopScreenShare()}),this.peers.forEach(t=>{if(this.localScreenStream){const a=this.localScreenStream.getVideoTracks()[0],n=t.pc.getSenders().find(i=>{var r;return((r=i.track)==null?void 0:r.kind)==="video"});n&&a&&n.replaceTrack(a)}}),this.localScreenStream)}catch(t){throw console.error("Error starting screen share:",t),t}}stopScreenShare(){if(this.localScreenStream&&(this.localScreenStream.getTracks().forEach(t=>t.stop()),this.localScreenStream=null,this.localStream)){const t=this.localStream.getVideoTracks()[0];this.peers.forEach(a=>{const n=a.pc.getSenders().find(i=>{var r;return((r=i.track)==null?void 0:r.kind)==="video"});n&&t&&n.replaceTrack(t)})}}createPeer(t,a){if(t===this.currentUserId)throw new Error("Cannot create peer for self");this.peers.has(t)&&this.removePeer(t);const n=new RTCPeerConnection(this.iceServers),i=this.localScreenStream||this.localStream;i&&i.getTracks().forEach(s=>{n.addTrack(s,i)}),n.onicecandidate=s=>{s.candidate&&this.meetingId&&this.currentUserId&&this.signaling.sendSignal(t,s.candidate,"ice-candidate")},n.ontrack=s=>{s.streams&&s.streams[0]&&this.onStreamCallback&&this.onStreamCallback(t,s.streams[0],!1)},n.onconnectionstatechange=()=>{console.log(`Connection state for ${t}:`,n.connectionState),n.connectionState==="connected"?console.log(`âœ… Connected to peer: ${t}`):(n.connectionState==="failed"||n.connectionState==="disconnected")&&(console.log(`ðŸ”Œ Peer disconnected: ${t}`),this.onErrorCallback&&this.onErrorCallback(t,new Error(`Connection ${n.connectionState}`)))},n.onerror=s=>{console.error(`âŒ Peer error for ${t}:`,s),this.onErrorCallback&&this.onErrorCallback(t,new Error("Peer connection error"))};const r={pc:n,userId:t,isInitiator:a};return this.peers.set(t,r),a&&this.createOffer(t),n}async createOffer(t){const a=this.peers.get(t);if(!(!a||!this.meetingId||!this.currentUserId))try{const n=await a.pc.createOffer();await a.pc.setLocalDescription(n),this.signaling.sendSignal(t,n,"offer")}catch(n){console.error(`Error creating offer for ${t}:`,n),this.onErrorCallback&&this.onErrorCallback(t,n)}}async createAnswer(t){const a=this.peers.get(t);if(!(!a||!this.meetingId||!this.currentUserId))try{const n=await a.pc.createAnswer();await a.pc.setLocalDescription(n),this.signaling.sendSignal(t,n,"answer")}catch(n){console.error(`Error creating answer for ${t}:`,n),this.onErrorCallback&&this.onErrorCallback(t,n)}}async handleSignal(t){const{fromUserId:a,signal:n,signalType:i}=t;if(a===this.currentUserId)return;let r=this.peers.get(a);if(!r&&i==="offer"&&(this.createPeer(a,!1),r=this.peers.get(a)),!r){console.warn(`No peer connection found for ${a}`);return}try{if(i==="offer")r.pc.signalingState==="stable"||r.pc.signalingState==="have-local-offer"?(await r.pc.setRemoteDescription(new RTCSessionDescription(n)),await this.createAnswer(a)):console.warn(`Ignoring offer from ${a}, wrong signaling state: ${r.pc.signalingState}`);else if(i==="answer")r.pc.signalingState==="have-local-offer"?await r.pc.setRemoteDescription(new RTCSessionDescription(n)):console.warn(`Ignoring answer from ${a}, wrong signaling state: ${r.pc.signalingState}`);else if(i==="ice-candidate"&&r.pc.signalingState!=="closed")try{await r.pc.addIceCandidate(new RTCIceCandidate(n))}catch(s){console.debug("ICE candidate error (can be ignored):",s)}}catch(s){console.error(`Error handling signal from ${a}:`,s),this.onErrorCallback&&this.onErrorCallback(a,s)}}toggleAudio(t){this.localStream&&this.localStream.getAudioTracks().forEach(a=>{a.enabled=t})}toggleVideo(t){this.localStream&&this.localStream.getVideoTracks().forEach(a=>{a.enabled=t})}onStream(t){this.onStreamCallback=t}onStreamEnd(t){this.onStreamEndCallback=t}onError(t){this.onErrorCallback=t}removePeer(t){const a=this.peers.get(t);a&&(a.pc.close(),this.peers.delete(t),this.onStreamEndCallback&&this.onStreamEndCallback(t))}cleanup(){this.localStream&&(this.localStream.getTracks().forEach(t=>t.stop()),this.localStream=null),this.localScreenStream&&(this.localScreenStream.getTracks().forEach(t=>t.stop()),this.localScreenStream=null),this.peers.forEach(t=>{t.pc.close()}),this.peers.clear(),this.onStreamCallback=null,this.onStreamEndCallback=null,this.onErrorCallback=null}getPeerIds(){return Array.from(this.peers.keys())}hasPeer(t){return this.peers.has(t)}getLocalStream(){return this.localStream}}function te({userId:c,stream:t,isLocal:a=!1,name:n="Unknown",avatarUrl:i,audioEnabled:r=!0,videoEnabled:s=!0,isScreenSharing:f=!1,connectionStatus:w="connected",className:b}){const u=l.useRef(null),[S,j]=l.useState(!1),P=l.useRef(null),E=l.useRef(null);l.useEffect(()=>(u.current&&t?(u.current.srcObject=t,u.current.play().catch(console.error),!a&&t.getAudioTracks().length>0&&$(t)):u.current&&!t&&(u.current.srcObject=null),()=>{P.current&&P.current.close()}),[t,a]);const $=h=>{try{const x=new(window.AudioContext||window.webkitAudioContext),d=x.createAnalyser(),_=x.createMediaStreamSource(h);d.fftSize=256,d.smoothingTimeConstant=.8,_.connect(d),P.current=x,E.current=d;const N=new Uint8Array(d.frequencyBinCount),T=()=>{if(E.current){E.current.getByteFrequencyData(N);const Z=N.reduce((B,F)=>B+F)/N.length;j(Z>30),requestAnimationFrame(T)}};T()}catch(x){console.error("Error setting up audio analysis:",x)}},M=h=>h.split(" ").map(x=>x[0]).join("").toUpperCase().slice(0,2),o=s&&(t==null?void 0:t.getVideoTracks().some(h=>h.enabled));return e.jsxs("div",{className:H("relative w-full h-full rounded-lg overflow-hidden bg-background border-2 transition-all",a?"border-primary":"border-border",S&&!a?"ring-2 ring-primary ring-offset-2":"",w==="connecting"&&"opacity-50",b),children:[e.jsx("video",{ref:u,autoPlay:!0,playsInline:!0,muted:a,className:H("w-full h-full object-cover",!o&&"hidden")}),!o&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-muted",children:e.jsxs(se,{className:"w-24 h-24",children:[e.jsx(ne,{src:i,alt:n}),e.jsx(re,{className:"text-2xl",children:i?e.jsx(ke,{className:"w-12 h-12"}):M(n)})]})}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:"text-white text-sm font-medium truncate",children:a?`${n} (You)`:n}),f&&e.jsx(G,{variant:"secondary",className:"text-xs",children:"Screen"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[r?e.jsx(le,{className:"w-4 h-4 text-white"}):e.jsx(oe,{className:"w-4 h-4 text-red-500"}),s?e.jsx(ie,{className:"w-4 h-4 text-white"}):e.jsx(ce,{className:"w-4 h-4 text-red-500"})]})]})}),w==="connecting"&&e.jsx("div",{className:"absolute top-2 left-2 bg-yellow-500 text-white text-xs px-2 py-1 rounded",children:"Connecting..."}),w==="disconnected"&&e.jsx("div",{className:"absolute top-2 left-2 bg-red-500 text-white text-xs px-2 py-1 rounded",children:"Disconnected"}),S&&!a&&e.jsx("div",{className:"absolute top-2 right-2 w-3 h-3 bg-green-500 rounded-full animate-pulse"})]})}function nt({audioEnabled:c,videoEnabled:t,screenSharing:a,onToggleAudio:n,onToggleVideo:i,onToggleScreenShare:r,onLeave:s,onShowParticipants:f,onShowChat:w,onShowSettings:b,participantCount:u,unreadMessages:S=0,className:j}){return e.jsxs("div",{className:H("flex items-center justify-center gap-2 p-4 bg-background border-t",j),children:[e.jsx(R,{variant:c?"default":"destructive",size:"icon",className:"rounded-full w-12 h-12",onClick:n,title:c?"Mute":"Unmute",children:c?e.jsx(le,{className:"w-5 h-5"}):e.jsx(oe,{className:"w-5 h-5"})}),e.jsx(R,{variant:t?"default":"destructive",size:"icon",className:"rounded-full w-12 h-12",onClick:i,title:t?"Turn off camera":"Turn on camera",children:t?e.jsx(ie,{className:"w-5 h-5"}):e.jsx(ce,{className:"w-5 h-5"})}),e.jsx(R,{variant:a?"default":"outline",size:"icon",className:"rounded-full w-12 h-12",onClick:r,title:a?"Stop sharing":"Share screen",children:a?e.jsx(Ke,{className:"w-5 h-5"}):e.jsx(Qe,{className:"w-5 h-5"})}),f&&e.jsxs(R,{variant:"outline",size:"icon",className:"rounded-full w-12 h-12 relative",onClick:f,title:"Participants",children:[e.jsx(Pe,{className:"w-5 h-5"}),u!==void 0&&u>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-primary text-primary-foreground text-xs rounded-full w-5 h-5 flex items-center justify-center",children:u})]}),w&&e.jsxs(R,{variant:"outline",size:"icon",className:"rounded-full w-12 h-12 relative",onClick:w,title:"Chat",children:[e.jsx(Ae,{className:"w-5 h-5"}),S>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:S>9?"9+":S})]}),b&&e.jsx(R,{variant:"outline",size:"icon",className:"rounded-full w-12 h-12",onClick:b,title:"Settings",children:e.jsx(Ie,{className:"w-5 h-5"})}),e.jsx(R,{variant:"destructive",size:"icon",className:"rounded-full w-12 h-12",onClick:s,title:"Leave meeting",children:e.jsx(et,{className:"w-5 h-5"})})]})}const de=l.forwardRef(({className:c,children:t,...a},n)=>e.jsx("div",{ref:n,className:H("overflow-auto",c),...a,children:t}));de.displayName="ScrollArea";function rt({participants:c,currentUserId:t,className:a}){const n=r=>r.split(" ").map(s=>s[0]).join("").toUpperCase().slice(0,2),i=[...c].sort((r,s)=>r.role==="host"&&s.role!=="host"?-1:r.role!=="host"&&s.role==="host"?1:r.role==="co-host"&&s.role==="participant"?-1:r.role==="participant"&&s.role==="co-host"?1:new Date(r.joinedAt).getTime()-new Date(s.joinedAt).getTime());return e.jsxs("div",{className:H("flex flex-col h-full bg-background",a),children:[e.jsx("div",{className:"p-4 border-b",children:e.jsxs("h3",{className:"font-semibold text-lg",children:["Participants (",c.length,")"]})}),e.jsx(de,{className:"flex-1",children:e.jsx("div",{className:"p-2 space-y-2",children:i.map(r=>{const s=r.userId===t;return e.jsxs("div",{className:H("flex items-center gap-3 p-3 rounded-lg transition-colors",s&&"bg-muted"),children:[e.jsxs(se,{className:"w-10 h-10",children:[e.jsx(ne,{src:r.avatarUrl,alt:r.name}),e.jsx(re,{children:r.avatarUrl?e.jsx(ke,{className:"w-5 h-5"}):n(r.name)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"font-medium text-sm truncate",children:[r.name,s&&" (You)"]}),r.role==="host"&&e.jsx(Je,{className:"w-4 h-4 text-yellow-500"}),r.handRaised&&e.jsx(G,{variant:"secondary",className:"text-xs",children:"âœ‹"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[r.audioEnabled?e.jsx(le,{className:"w-3 h-3 text-muted-foreground"}):e.jsx(oe,{className:"w-3 h-3 text-red-500"}),r.videoEnabled?e.jsx(ie,{className:"w-3 h-3 text-muted-foreground"}):e.jsx(ce,{className:"w-3 h-3 text-red-500"}),r.screenSharing&&e.jsx(G,{variant:"outline",className:"text-xs",children:"Screen"}),r.connectionStatus==="connecting"&&e.jsx(G,{variant:"outline",className:"text-xs text-yellow-500",children:"Connecting..."}),r.connectionStatus==="disconnected"&&e.jsx(G,{variant:"outline",className:"text-xs text-red-500",children:"Disconnected"})]})]})]},r.userId)})})})]})}function it({meetingId:c,currentUserId:t,className:a}){const[n,i]=l.useState([]),[r,s]=l.useState(""),[f,w]=l.useState(!1),b=l.useRef(null),u=ae();l.useEffect(()=>{S()},[c]),l.useEffect(()=>{const o=u.channel(`meeting-chat-${c}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"meeting_messages",filter:`meeting_id=eq.${c}`},h=>{j(h.new.id)}).subscribe();return()=>{u.removeChannel(o)}},[c]);const S=async()=>{try{const{data:o,error:h}=await u.from("meeting_messages").select("*, profiles:user_id(full_name, avatar_url)").eq("meeting_id",c).order("created_at",{ascending:!0});if(h)throw h;if(o){const x=o.map(d=>{var _,N;return{id:d.id,userId:d.user_id,userName:((_=d.profiles)==null?void 0:_.full_name)||"Unknown",userAvatar:(N=d.profiles)==null?void 0:N.avatar_url,content:d.content,messageType:d.message_type,createdAt:d.created_at}});i(x),E()}}catch(o){console.error("Error loading messages:",o)}},j=async o=>{var h,x;try{const{data:d,error:_}=await u.from("meeting_messages").select("*, profiles:user_id(full_name, avatar_url)").eq("id",o).single();if(_)throw _;if(d){const N={id:d.id,userId:d.user_id,userName:((h=d.profiles)==null?void 0:h.full_name)||"Unknown",userAvatar:(x=d.profiles)==null?void 0:x.avatar_url,content:d.content,messageType:d.message_type,createdAt:d.created_at};i(T=>[...T,N]),E()}}catch(d){console.error("Error loading message:",d)}},P=async()=>{if(!(!r.trim()||f)){w(!0);try{const{error:o}=await u.from("meeting_messages").insert({meeting_id:c,user_id:t,content:r.trim(),message_type:"text"});if(o)throw o;s("")}catch(o){console.error("Error sending message:",o)}finally{w(!1)}}},E=()=>{setTimeout(()=>{var o;(o=b.current)==null||o.scrollIntoView({behavior:"smooth"})},100)},$=o=>o.split(" ").map(h=>h[0]).join("").toUpperCase().slice(0,2),M=o=>{try{return qe(new Date(o),"HH:mm")}catch{return""}};return e.jsxs("div",{className:`flex flex-col h-full bg-background ${a}`,children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h3",{className:"font-semibold text-lg",children:"Chat"})}),e.jsx(de,{className:"flex-1 p-4",children:e.jsxs("div",{className:"space-y-4",children:[n.map(o=>{const h=o.userId===t;return o.messageType==="system"?e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"bg-muted text-muted-foreground text-sm px-3 py-1 rounded-full",children:o.content})},o.id):e.jsxs("div",{className:`flex gap-3 ${h?"flex-row-reverse":""}`,children:[e.jsxs(se,{className:"w-8 h-8 shrink-0",children:[e.jsx(ne,{src:o.userAvatar,alt:o.userName}),e.jsx(re,{className:"text-xs",children:$(o.userName)})]}),e.jsxs("div",{className:`flex flex-col gap-1 ${h?"items-end":"items-start"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:o.userName}),e.jsx("span",{className:"text-xs text-muted-foreground",children:M(o.createdAt)})]}),e.jsx("div",{className:`rounded-lg px-3 py-2 max-w-[80%] ${h?"bg-primary text-primary-foreground":"bg-muted"}`,children:e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:o.content})})]})]},o.id)}),e.jsx("div",{ref:b})]})}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("form",{onSubmit:o=>{o.preventDefault(),P()},className:"flex gap-2",children:[e.jsx(Re,{value:r,onChange:o=>s(o.target.value),placeholder:"Type a message...",disabled:f,className:"flex-1"}),e.jsx(R,{type:"submit",disabled:f||!r.trim(),size:"icon",children:e.jsx($e,{className:"w-4 h-4"})})]})})]})}function ye(c){c&&c.getTracks().forEach(t=>{t.stop()})}function ht(){var me,ge,fe,pe;const c=De(),[,t]=Ve(),a=c.id,n=ae(),[i,r]=l.useState(null),[s,f]=l.useState(null),[w,b]=l.useState(!0),[u,S]=l.useState(null),[j,P]=l.useState(null),[E,$]=l.useState(new Map),[M,o]=l.useState(!0),[h,x]=l.useState(!0),[d,_]=l.useState(!1),[N,T]=l.useState(!1),[Z,B]=l.useState("participants"),[F,Ne]=l.useState([]),[ee,ot]=l.useState(0),he=l.useRef(null),q=l.useRef(null),L=l.useRef(new Map);l.useEffect(()=>a?((async()=>{var v,C,y,K;try{b(!0);const{data:{user:k}}=await n.auth.getUser();if(!k){S("You must be logged in");return}f(k.id);const{data:U,error:xe}=await n.from("meetings").select("*").eq("id",a).single();if(xe)throw xe;if(!U){S("Meeting not found");return}if(r(U),U.status==="ended"||U.status==="cancelled"){S("This meeting has ended");return}const{error:we}=await n.from("meeting_participants").upsert({meeting_id:a,user_id:k.id,role:U.host_id===k.id?"host":"participant",left_at:null,connection_status:"connecting"},{onConflict:"meeting_id,user_id"});if(we)throw we;const X=new at,D=new st(X);he.current=X,q.current=D,D.initialize(a,k.id),D.onStream((V,O,A)=>{A?P(O):$(Y=>{const Q=new Map(Y);return Q.set(V,O),Q})}),D.onStreamEnd(V=>{$(O=>{const A=new Map(O);return A.delete(V),A})}),await X.joinMeeting(a,k.id),X.onParticipantChange(async V=>{const O=V.map(g=>g.userId),{data:A}=await n.from("profiles").select("id, full_name, avatar_url").in("id",O),Y=new Map;A==null||A.forEach(g=>{Y.set(g.id,{name:g.full_name||"Unknown",avatarUrl:g.avatar_url})}),L.current=Y;const Q=V.map(g=>{const I=Y.get(g.userId);return{userId:g.userId,name:(I==null?void 0:I.name)||"Unknown",avatarUrl:I==null?void 0:I.avatarUrl,role:g.role,audioEnabled:g.audioEnabled,videoEnabled:g.videoEnabled,screenSharing:g.screenSharing,handRaised:g.handRaised,connectionStatus:g.connectionStatus,joinedAt:g.joinedAt}});Ne(Q);const Se=D.getPeerIds();V.forEach(g=>{if(g.userId!==k.id&&!Se.includes(g.userId)){const I=Se.length===0;D.createPeer(g.userId,I)}})});const lt=await D.initializeLocalStream(((v=U.settings)==null?void 0:v.muteOnJoin)!==!1,((C=U.settings)==null?void 0:C.videoOnJoin)!==!1);o(((y=U.settings)==null?void 0:y.muteOnJoin)!==!1),x(((K=U.settings)==null?void 0:K.videoOnJoin)!==!1),await n.from("meeting_participants").update({connection_status:"connected"}).eq("meeting_id",a).eq("user_id",k.id)}catch(k){console.error("Error initializing meeting:",k),S(k.message||"Failed to join meeting"),ve.error("Error",k.message||"Failed to join meeting")}finally{b(!1)}})(),()=>{ue()}):void 0,[a]);const ue=async()=>{var m,v;s&&a&&await n.from("meeting_participants").update({left_at:new Date().toISOString(),connection_status:"disconnected"}).eq("meeting_id",a).eq("user_id",s),ye(j),E.forEach(C=>ye(C)),(m=q.current)==null||m.cleanup(),(v=he.current)==null||v.leaveMeeting(),P(null),$(new Map)},Ce=l.useCallback(()=>{var v;const m=!M;o(m),(v=q.current)==null||v.toggleAudio(m),s&&a&&n.from("meeting_participants").update({audio_enabled:m}).eq("meeting_id",a).eq("user_id",s)},[M,s,a]),Ee=l.useCallback(()=>{var v;const m=!h;x(m),(v=q.current)==null||v.toggleVideo(m),s&&a&&n.from("meeting_participants").update({video_enabled:m}).eq("meeting_id",a).eq("user_id",s)},[h,s,a]),_e=l.useCallback(async()=>{if(q.current)try{d?(q.current.stopScreenShare(),_(!1)):(await q.current.startScreenShare(),_(!0)),s&&a&&n.from("meeting_participants").update({screen_sharing:!d}).eq("meeting_id",a).eq("user_id",s)}catch(m){console.error("Error toggling screen share:",m),ve.error("Error",m.message||"Failed to toggle screen share")}},[d,s,a]),Me=l.useCallback(async()=>{await ue(),t("/dashboard/meetings")},[]);if(w)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Joining meeting..."})})});if(u)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-destructive text-lg",children:u}),e.jsx("button",{onClick:()=>t("/dashboard/meetings"),className:"text-primary hover:underline",children:"Go back to meetings"})]})});const J=[j,...Array.from(E.values())].filter(Boolean),W=F.length;return e.jsxs("div",{className:"min-h-screen bg-background flex flex-col",children:[e.jsxs("div",{className:"bg-background border-b px-4 py-2 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"font-semibold",children:(i==null?void 0:i.title)||"Meeting"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[W," participant",W!==1?"s":""]})]}),e.jsx("button",{onClick:()=>T(!N),className:"text-muted-foreground hover:text-foreground",children:e.jsx(ze,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"flex-1 relative overflow-hidden",children:e.jsx("div",{className:"absolute inset-0 p-4",children:J.length===0?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-muted-foreground",children:"Waiting for participants..."})}):J.length===1?e.jsx("div",{className:"h-full",children:j&&e.jsx(te,{userId:s||"",stream:j,isLocal:!0,name:((me=L.current.get(s||""))==null?void 0:me.name)||"You",avatarUrl:(ge=L.current.get(s||""))==null?void 0:ge.avatarUrl,audioEnabled:M,videoEnabled:h,className:"h-full"})}):e.jsxs("div",{className:`grid gap-4 h-full ${J.length===2?"grid-cols-1":J.length<=4?"grid-cols-2":J.length<=9?"grid-cols-3":"grid-cols-4"}`,children:[j&&e.jsx(te,{userId:s||"",stream:j,isLocal:!0,name:((fe=L.current.get(s||""))==null?void 0:fe.name)||"You",avatarUrl:(pe=L.current.get(s||""))==null?void 0:pe.avatarUrl,audioEnabled:M,videoEnabled:h}),Array.from(E.entries()).map(([m,v])=>{const C=L.current.get(m),y=F.find(K=>K.userId===m);return e.jsx(te,{userId:m,stream:v,name:(C==null?void 0:C.name)||"Unknown",avatarUrl:C==null?void 0:C.avatarUrl,audioEnabled:(y==null?void 0:y.audioEnabled)??!0,videoEnabled:(y==null?void 0:y.videoEnabled)??!0,connectionStatus:y==null?void 0:y.connectionStatus},m)})]})})}),e.jsx(nt,{audioEnabled:M,videoEnabled:h,screenSharing:d,onToggleAudio:Ce,onToggleVideo:Ee,onToggleScreenShare:_e,onLeave:Me,onShowParticipants:()=>{T(!0),B("participants")},onShowChat:()=>{T(!0),B("chat")},participantCount:W,unreadMessages:ee}),e.jsx(Le,{open:N,onOpenChange:T,children:e.jsx(Oe,{side:"right",className:"w-full sm:w-96 p-0",children:e.jsxs(He,{value:Z,onValueChange:m=>B(m),children:[e.jsxs(Be,{className:"w-full rounded-none border-b",children:[e.jsxs(be,{value:"participants",className:"flex-1",children:["Participants (",W,")"]}),e.jsxs(be,{value:"chat",className:"flex-1",children:["Chat ",ee>0&&`(${ee})`]})]}),e.jsx(je,{value:"participants",className:"m-0 h-[calc(100vh-120px)]",children:e.jsx(rt,{participants:F,currentUserId:s||"",className:"h-full"})}),e.jsx(je,{value:"chat",className:"m-0 h-[calc(100vh-120px)]",children:a&&s&&e.jsx(it,{meetingId:a,currentUserId:s,className:"h-full"})})]})})})]})}export{ht as default};
